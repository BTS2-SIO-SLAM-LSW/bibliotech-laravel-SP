#!/bin/bash

echo "üîß CORRECTION AUTOMATIQUE - Option A"
echo "===================================="
echo "Mise √† jour du code pour correspondre aux exercices"
echo

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Fonction de confirmation
confirm() {
    read -p "$(echo -e ${YELLOW}$1${NC}) [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        return 0
    else
        return 1
    fi
}

echo -e "${YELLOW}‚ö†Ô∏è  Cette op√©ration va modifier le code source${NC}"
echo "Les changements incluent:"
echo "  ‚Ä¢ Renommer Categorie ‚Üí Category"
echo "  ‚Ä¢ Ajouter colonnes icone et active"
echo "  ‚Ä¢ Mettre √† jour toutes les relations"
echo "  ‚Ä¢ Corriger les seeders"
echo

if ! confirm "Voulez-vous continuer ?"; then
    echo -e "${RED}‚ùå Op√©ration annul√©e${NC}"
    exit 1
fi

echo
echo -e "${GREEN}üöÄ D√©but des corrections...${NC}"
echo

# √âTAPE 1: Renommer le mod√®le Categorie ‚Üí Category
echo "üìù √âTAPE 1/6: Renommer le mod√®le Categorie ‚Üí Category"
if [ -f "app/Models/Categorie.php" ]; then
    mv app/Models/Categorie.php app/Models/Category.php
    echo -e "${GREEN}‚úÖ Fichier renomm√©${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Fichier Categorie.php d√©j√† renomm√© ou introuvable${NC}"
fi

# √âTAPE 2: Mettre √† jour le contenu du mod√®le Category
echo
echo "üìù √âTAPE 2/6: Mise √† jour du mod√®le Category"

cat > app/Models/Category.php << 'EOF'
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Category extends Model
{
    use HasFactory;
    
    protected $table = 'categories';
    
    protected $fillable = [
        'nom',
        'description',
        'slug',
        'couleur',
        'icone',
        'active'
    ];
    
    protected $casts = [
        'active' => 'boolean'
    ];
    
    /**
     * Une cat√©gorie peut avoir plusieurs livres
     */
    public function livres()
    {
        return $this->hasMany(Livre::class, 'category_id');
    }
    
    /**
     * Scope pour les cat√©gories actives
     */
    public function scopeActives($query)
    {
        return $query->where('active', true);
    }
    
    /**
     * Scope pour rechercher par nom
     */
    public function scopeRecherche($query, $terme)
    {
        return $query->where('nom', 'like', '%' . $terme . '%')
                    ->orWhere('description', 'like', '%' . $terme . '%');
    }
    
    /**
     * Scope pour trouver par slug
     */
    public function scopeParSlug($query, $slug)
    {
        return $query->where('slug', $slug);
    }
    
    /**
     * Accesseur pour l'URL de la cat√©gorie
     */
    public function getUrlAttribute()
    {
        return route('categorie.show', $this->slug);
    }
}
EOF

echo -e "${GREEN}‚úÖ Mod√®le Category mis √† jour avec colonnes icone et active${NC}"

# √âTAPE 3: Mettre √† jour le mod√®le Livre
echo
echo "üìù √âTAPE 3/6: Mise √† jour du mod√®le Livre"

cat > app/Models/Livre.php << 'EOF'
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Livre extends Model
{
    use HasFactory;
    
    protected $table = 'livres';
    
    protected $fillable = [
        'titre',
        'auteur',
        'annee',
        'nb_pages',
        'isbn',
        'resume',
        'couverture',
        'disponible',
        'category_id'
    ];
    
    protected $casts = [
        'disponible' => 'boolean',
        'annee' => 'integer',
        'nb_pages' => 'integer'
    ];
    
    /**
     * Scope pour les livres disponibles
     */
    public function scopeDisponible($query)
    {
        return $query->where('disponible', true);
    }
    
    /**
     * Scope pour rechercher par titre ou auteur
     */
    public function scopeRecherche($query, $terme)
    {
        return $query->where('titre', 'like', '%' . $terme . '%')
                    ->orWhere('auteur', 'like', '%' . $terme . '%');
    }

    /**
     * Un livre appartient √† une cat√©gorie
     */
    public function category()
    {
        return $this->belongsTo(Category::class, 'category_id');
    }

    /**
     * Alias pour compatibilit√©
     */
    public function categorie()
    {
        return $this->category();
    }

    /**
     * Scope pour filtrer par cat√©gorie via relation
     */
    public function scopeParCategorie($query, $categorieSlug)
    {
        return $query->whereHas('category', function ($q) use ($categorieSlug) {
            $q->where('slug', $categorieSlug);
        });
    }

    /**
     * Accesseur pour l'URL du livre
     */
    public function getUrlAttribute()
    {
        return route('livre.show', $this->id);
    }
}
EOF

echo -e "${GREEN}‚úÖ Mod√®le Livre mis √† jour (category + alias categorie)${NC}"

# √âTAPE 4: Cr√©er migration pour ajouter colonnes manquantes
echo
echo "üìù √âTAPE 4/6: Cr√©ation migration pour colonnes icone et active"

TIMESTAMP=$(date +%Y_%m_%d_%H%M%S)
MIGRATION_FILE="database/migrations/${TIMESTAMP}_add_icone_active_to_categories.php"

cat > "$MIGRATION_FILE" << 'EOF'
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::table('categories', function (Blueprint $table) {
            $table->string('icone')->default('fas fa-book')->after('couleur');
            $table->boolean('active')->default(true)->after('icone');
        });
    }

    public function down(): void
    {
        Schema::table('categories', function (Blueprint $table) {
            $table->dropColumn(['icone', 'active']);
        });
    }
};
EOF

echo -e "${GREEN}‚úÖ Migration cr√©√©e: $MIGRATION_FILE${NC}"

# √âTAPE 5: Renommer et mettre √† jour CategorySeeder
echo
echo "üìù √âTAPE 5/6: Mise √† jour des seeders"

if [ -f "database/seeders/CategorieSeeder.php" ]; then
    mv database/seeders/CategorieSeeder.php database/seeders/CategorySeeder.php
    echo -e "${GREEN}‚úÖ Seeder renomm√©${NC}"
fi

cat > database/seeders/CategorySeeder.php << 'EOF'
<?php

namespace Database\Seeders;

use App\Models\Category;
use Illuminate\Database\Seeder;

class CategorySeeder extends Seeder
{
    public function run(): void
    {
        $categories = [
            [
                'nom' => 'Laravel',
                'description' => 'Framework PHP moderne et √©l√©gant',
                'slug' => 'laravel',
                'couleur' => '#FF2D20',
                'icone' => 'fab fa-laravel',
                'active' => true
            ],
            [
                'nom' => 'PHP',
                'description' => 'Langage de programmation c√¥t√© serveur',
                'slug' => 'php',
                'couleur' => '#777BB4',
                'icone' => 'fab fa-php',
                'active' => true
            ],
            [
                'nom' => 'Base de Donn√©es',
                'description' => 'Gestion et manipulation de donn√©es',
                'slug' => 'database',
                'couleur' => '#4DB33D',
                'icone' => 'fas fa-database',
                'active' => true
            ],
            [
                'nom' => 'Frontend',
                'description' => 'D√©veloppement d\'interfaces utilisateur',
                'slug' => 'frontend',
                'couleur' => '#61DAFB',
                'icone' => 'fas fa-palette',
                'active' => true
            ],
            [
                'nom' => 'DevOps',
                'description' => 'D√©ploiement et infrastructure',
                'slug' => 'devops',
                'couleur' => '#2496ED',
                'icone' => 'fas fa-server',
                'active' => true
            ],
            [
                'nom' => 'Architecture',
                'description' => 'Patterns et bonnes pratiques',
                'slug' => 'architecture',
                'couleur' => '#F7DF1E',
                'icone' => 'fas fa-sitemap',
                'active' => true
            ]
        ];

        foreach ($categories as $categorieData) {
            Category::create($categorieData);
        }
    }
}
EOF

echo -e "${GREEN}‚úÖ CategorySeeder cr√©√© avec colonnes icone et active${NC}"

# Mettre √† jour LivreSeeder
cat > database/seeders/LivreSeeder.php << 'EOF'
<?php

namespace Database\Seeders;

use App\Models\Livre;
use App\Models\Category;
use Illuminate\Database\Seeder;

class LivreSeeder extends Seeder
{
    public function run(): void
    {
        $laravel = Category::where('slug', 'laravel')->first();
        $php = Category::where('slug', 'php')->first();
        $database = Category::where('slug', 'database')->first();
        $frontend = Category::where('slug', 'frontend')->first();
        $devops = Category::where('slug', 'devops')->first();
        $architecture = Category::where('slug', 'architecture')->first();

        $livres = [
            [
                'titre' => 'Laravel pour D√©butants',
                'auteur' => 'John Smith',
                'annee' => 2024,
                'nb_pages' => 320,
                'isbn' => '978-2-1234-5678-9',
                'resume' => 'Guide complet pour apprendre Laravel √©tape par √©tape.',
                'couverture' => 'laravel.jpg',
                'disponible' => true,
                'category_id' => $laravel?->id,
            ],
            [
                'titre' => 'Docker en Pratique',
                'auteur' => 'Marie Dubois',
                'annee' => 2023,
                'nb_pages' => 280,
                'isbn' => '978-2-1234-5679-6',
                'resume' => 'Ma√Ætriser la containerisation avec Docker.',
                'couverture' => 'docker.jpg',
                'disponible' => true,
                'category_id' => $devops?->id,
            ],
            [
                'titre' => 'MVC Expliqu√© Simplement',
                'auteur' => 'Pierre Martin',
                'annee' => 2024,
                'nb_pages' => 195,
                'isbn' => '978-2-1234-5680-2',
                'resume' => 'Comprendre l\'architecture MVC avec des exemples concrets.',
                'couverture' => 'mvc.jpg',
                'disponible' => false,
                'category_id' => $architecture?->id,
            ],
            [
                'titre' => 'PHP 8 - Les Nouveaut√©s',
                'auteur' => 'Lucas Bernard',
                'annee' => 2024,
                'nb_pages' => 245,
                'isbn' => '978-2-1234-5682-6',
                'resume' => 'D√©couvrez toutes les nouveaut√©s de PHP 8.',
                'couverture' => 'php8.jpg',
                'disponible' => true,
                'category_id' => $php?->id,
            ],
            [
                'titre' => 'SQLite pour les Applications Modernes',
                'auteur' => 'Sophie Moreau',
                'annee' => 2023,
                'nb_pages' => 350,
                'isbn' => '978-2-1234-5681-9',
                'resume' => 'Guide complet de SQLite pour le d√©veloppement.',
                'couverture' => 'sqlite.jpg',
                'disponible' => true,
                'category_id' => $database?->id,
            ],
            [
                'titre' => 'Bootstrap 5 et CSS Moderne',
                'auteur' => 'Emma Wilson',
                'annee' => 2024,
                'nb_pages' => 290,
                'isbn' => '978-2-1234-5683-3',
                'resume' => 'Cr√©er des interfaces modernes avec Bootstrap 5.',
                'couverture' => 'bootstrap5.jpg',
                'disponible' => true,
                'category_id' => $frontend?->id,
            ]
        ];

        foreach ($livres as $livre) {
            Livre::create($livre);
        }
    }
}
EOF

echo -e "${GREEN}‚úÖ LivreSeeder mis √† jour pour utiliser Category${NC}"

# √âTAPE 6: Mettre √† jour DatabaseSeeder
echo
echo "üìù √âTAPE 6/6: Mise √† jour DatabaseSeeder"

cat > database/seeders/DatabaseSeeder.php << 'EOF'
<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;

class DatabaseSeeder extends Seeder
{
    public function run(): void
    {
        $this->call([
            CategorySeeder::class,
            LivreSeeder::class,
        ]);
    }
}
EOF

echo -e "${GREEN}‚úÖ DatabaseSeeder mis √† jour${NC}"

# R√©sum√© final
echo
echo -e "${GREEN}‚úÖ CORRECTIONS TERMIN√âES !${NC}"
echo
echo "üìã R√©sum√© des modifications:"
echo "  ‚úÖ Mod√®le Categorie ‚Üí Category"
echo "  ‚úÖ Ajout colonnes: icone, active"
echo "  ‚úÖ Ajout scope: actives()"
echo "  ‚úÖ Relations mises √† jour (category + alias categorie)"
echo "  ‚úÖ Seeders corrig√©s et renomm√©s"
echo "  ‚úÖ Migration cr√©√©e pour nouvelles colonnes"
echo
echo "üöÄ PROCHAINES √âTAPES:"
echo "  1. php artisan migrate (pour ajouter icone et active)"
echo "  2. php artisan migrate:fresh --seed (pour tout recr√©er)"
echo "  3. Tester les exercices dans Tinker"
echo
echo "üìù Test rapide sugg√©r√©:"
echo "  php artisan tinker"
echo "  >>> App\Models\Category::count()"
echo "  >>> App\Models\Category::actives()->get()"
echo "  >>> App\Models\Livre::with('category')->first()"
echo
